<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="img/image.png" type="image/png">
    <title>Shopping Cart - Online Shopping Website</title>
    <meta name="description" content="Review your shopping cart and place orders">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link rel="stylesheet" href="shop.css">
</head>

<body>
    <section id="header">
        <a href="#"><img src="img/logo.png" class="logo" alt="Brand Logo"></a>

        <div>
            <ul id="navbar">
                <li><a href="index.html">Home</a></li>
                <li><a href="shop.html">Shop</a></li>
                <li><a href="order-history.html">Order History</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li id="lg-bag"><a class="active" href="cart.html"><i class="fa fa-shopping-bag"></i></a></li>
                <a href="#" id="close"><i class="far fa-times"></i></a>
                <li><a href="login.html" id="login-icon"><i class="far fa-user"></i></a></li>
            </ul>
        </div>
        <div id="mobile">
            <a href="cart.html"><i class="fa fa-shopping-bag"></i></a>
            <i id="bar" class="fas fa-outdent"></i>
        </div>
    </section>

    <section id="page-header" class="cart-header">
        <h2>Shopping Cart</h2>
        <p>Review your items and complete your purchase</p>
    </section>

    <section id="cart" class="section-p1">
        <table width="100%">
            <thead>
                <tr>
                    <td>Remove</td>
                    <td>Image</td>
                    <td>Product</td>
                    <td>Price</td>
                    <td>Quantity</td>
                    <td>Subtotal</td>
                </tr>
            </thead>
            <tbody id="cart-products">
                <!-- Cart items will be loaded dynamically via JavaScript -->
            </tbody>
        </table>
    </section>

    <section id="cart-add" class="section-p1">
        <div id="coupon">
            <h3>Apply Coupon</h3>
            <div>
                <input type="text" placeholder="Enter Your Coupon">
                <button class="normal">Apply</button>
            </div>
        </div>

        <div id="subtotal">
            <h3>Cart Totals</h3>
            <table>
                <tr>
                    <td>Cart Subtotal</td>
                    <td id="cart-subtotal">$0</td>
                </tr>
                <tr>
                    <td>Shipping</td>
                    <td id="shipping-cost">Free</td>
                </tr>
                <tr>
                    <td><strong>Total</strong></td>
                    <td id="cart-total"><strong>$0</strong></td>
                </tr>
            </table>
            <button class="normal" id="proceed-btn">Proceed to Checkout</button>
        </div>
    </section>

    <!-- Checkout Form -->
    <section id="checkout-form" class="section-p1" style="display:none;">
        <h2>Checkout</h2>
        <div class="checkout-container">
            <div class="shipping-info">
                <h3>Shipping Information</h3>
                <form id="shipping-form">
                    <div class="form-group">
                        <label for="fullname">Full Name</label>
                        <input type="text" id="fullname" name="fullname" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" id="address" name="address" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" name="state" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="zipcode">Zip Code</label>
                            <input type="text" id="zipcode" name="zipcode" required>
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" name="country" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="payment-info">
                <h3>Payment Information</h3>
                <form id="payment-form">
                    <div class="form-group">
                        <label for="cardname">Name on Card</label>
                        <input type="text" id="cardname" name="cardname" required>
                    </div>
                    <div class="form-group">
                        <label for="cardnumber">Card Number</label>
                        <input type="text" id="cardnumber" name="cardnumber" placeholder="xxxx xxxx xxxx xxxx" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry">Expiry Date</label>
                            <input type="text" id="expiry" name="expiry" placeholder="MM/YY" required>
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" name="cvv" placeholder="123" required>
                        </div>
                    </div>
                </form>
                <div class="payment-methods">
                    <img src="img/pay/pay.png" alt="Payment Methods">
                </div>
                <button class="normal" id="place-order-btn">Place Order</button>
                <button class="normal outline" id="back-to-cart-btn">Back to Cart</button>
            </div>
        </div>
    </section>

    <!-- Order Confirmation -->
    <section id="order-confirmation" class="section-p1" style="display:none;">
        <div class="confirmation-container">
            <div class="confirmation-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Order Placed Successfully!</h2>
            <p>Your order has been placed and is being processed.</p>
            <p>Order Number: <span id="order-number">ORD-12345</span></p>
            <p>You will receive an email confirmation shortly at <span id="confirmation-email"></span></p>
            <div class="confirmation-buttons">
                <button class="normal" onclick="window.location.href='shop.html'">Continue Shopping</button>
                <button class="normal outline" onclick="window.location.href='index.html'">Go to Home</button>
            </div>
        </div>
    </section>

    <section id="newsletter" class="section-p1 section-m1">
        <div class="newstext">
            <h4>Sign Up For Newsletters</h4>
            <p>Get E-mail updates about our latest shop and <span>special offers.</span></p>
        </div>
        <div class="form">
            <input type="text" placeholder="Your email address">
            <button class="normal">Sign Up</button>
        </div>
    </section>

    <footer class="section-p1">
        <div class="col">
            <img class="logo" src="img/logo.png" alt="Brand Logo">
            <h4>Contact</h4>
            <p><strong>Address:</strong>PUNE</p>
            <p><strong>Phone:</strong> +91 9579157355</p>
            <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
            <div class="follow">
                <h4>Follow Us</h4>
                <div class="icon">
                    <i class="fab fa-facebook-f"></i>
                    <i class="fab fa-twitter"></i>
                    <i class="fab fa-instagram"></i>
                    <i class="fab fa-pinterest-p"></i>
                    <i class="fab fa-youtube"></i>
                </div>
            </div>
        </div>

        <div class="col">
            <h4>About</h4>
            <a href="#">About Us</a>
            <a href="#">Delivery Information</a>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms & Conditions</a>
            <a href="#">Contact Us</a>
        </div>

        <div class="col">
            <h4>My Account</h4>
            <a href="#">Sign In</a>
            <a href="#">View Cart</a>
            <a href="#">My Wishlist</a>
            <a href="#">Track My Order</a>
            <a href="#">Help</a>
        </div>

        <div class="col install">
            <h4>Install App</h4>
            <p>From App Store or Google Play</p>
            <div class="row">
                <img src="img/pay/app.jpg" alt="App Store">
                <img src="img/pay/play.jpg" alt="Google Play">
            </div>
            <p>Secured Payment Gateways</p>
            <img src="img/pay/pay.png" alt="Payment Methods">
        </div>

        <div class="copyright">
            <p>Â© 2025, E-Commerce Website - All Rights Reserved</p>
        </div>
    </footer>

    <script>
        // Environment configuration (fixed for browser compatibility)
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000' 
            : 'https://your-production-api.com'; // Replace with your production API URL

        // User ID (for demo; in production, get this from authentication)
        const userId = 'user123'; // Replace with actual user ID from auth system

        // DOM Elements
        const cartProductsEl = document.getElementById('cart-products');
        const cartSubtotalEl = document.getElementById('cart-subtotal');
        const cartTotalEl = document.getElementById('cart-total');
        const proceedBtn = document.getElementById('proceed-btn');
        const backToCartBtn = document.getElementById('back-to-cart-btn');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const cartSection = document.getElementById('cart');
        const cartAddSection = document.getElementById('cart-add');
        const checkoutFormSection = document.getElementById('checkout-form');
        const orderConfirmationSection = document.getElementById('order-confirmation');
        const confirmationEmailEl = document.getElementById('confirmation-email');
        const orderNumberEl = document.getElementById('order-number');

        // Load cart from backend
        async function loadCart() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/cart/${userId}`);
                const cart = await response.json();

                if (!cart.items || cart.items.length === 0) {
                    cartProductsEl.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px;">
                                <p>Your cart is empty</p>
                                <button class="normal" onclick="window.location.href='shop.html'" style="margin-top: 20px;">
                                    Continue Shopping
                                </button>
                            </td>
                        </tr>
                    `;
                    proceedBtn.disabled = true;
                    proceedBtn.classList.add('disabled');
                    updateCartTotals(0);
                    return;
                }

                let cartHtml = '';
                let subtotal = 0;

                cart.items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;

                    cartHtml += `
                        <tr>
                            <td><a href="#" class="remove-item" data-id="${item.productId}"><i class="far fa-times-circle"></i></a></td>
                            <td><img src="${item.image || 'img/placeholder.jpg'}" alt="${item.name}" style="width: 50px;"></td>
                            <td>${item.name}</td>
                            <td>$${item.price}</td>
                            <td>
                                <div class="quantity-selector">
                                    <button class="qty-btn minus" data-id="${item.productId}">-</button>
                                    <input type="number" value="${item.quantity}" min="1" class="qty-input" data-id="${item.productId}">
                                    <button class="qty-btn plus" data-id="${item.productId}">+</button>
                                </div>
                            </td>
                            <td>$${itemTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });

                cartProductsEl.innerHTML = cartHtml;
                updateCartTotals(subtotal);
                addQuantityListeners();
                addRemoveItemListeners();
            } catch (err) {
                console.error('Error loading cart:', err);
                cartProductsEl.innerHTML = '<tr><td colspan="6">Error loading cart</td></tr>';
            }
        }

        // Update cart totals
        function updateCartTotals(subtotal) {
            cartSubtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            cartTotalEl.textContent = `$${subtotal.toFixed(2)}`;
        }

        // Add event listeners to quantity selectors
        function addQuantityListeners() {
            document.querySelectorAll('.qty-btn.minus').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = this.dataset.id;
                    const input = document.querySelector(`.qty-input[data-id="${id}"]`);
                    const currentValue = parseInt(input.value);

                    if (currentValue > 1) {
                        input.value = currentValue - 1;
                        await updateItemQuantity(id, currentValue - 1);
                    }
                });
            });

            document.querySelectorAll('.qty-btn.plus').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = this.dataset.id;
                    const input = document.querySelector(`.qty-input[data-id="${id}"]`);
                    const currentValue = parseInt(input.value);

                    input.value = currentValue + 1;
                    await updateItemQuantity(id, currentValue + 1);
                });
            });

            document.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('change', async function() {
                    const id = this.dataset.id;
                    const value = parseInt(this.value);

                    if (value < 1) {
                        this.value = 1;
                        await updateItemQuantity(id, 1);
                    } else {
                        await updateItemQuantity(id, value);
                    }
                });
            });
        }

        // Add event listeners to remove item buttons
        function addRemoveItemListeners() {
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const id = this.dataset.id;
                    await removeItemFromCart(id);
                });
            });
        }

        // Update item quantity in cart
        async function updateItemQuantity(productId, quantity) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/cart/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, quantity }),
                });
                if (response.ok) {
                    loadCart(); // Reload cart to reflect changes
                } else {
                    console.error('Failed to update quantity:', await response.text());
                }
            } catch (err) {
                console.error('Error updating quantity:', err);
            }
        }

        // Remove item from cart
        async function removeItemFromCart(productId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/cart/${userId}/${productId}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    loadCart(); // Reload cart to reflect changes
                } else {
                    console.error('Failed to remove item:', await response.text());
                }
            } catch (err) {
                console.error('Error removing item:', err);
            }
        }

        // Add product to cart (called from index.html or shop.html)
        async function addToCart(productId, name, price, image) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/cart/${userId}`, { // Fixed typo: removed "cenapi"
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, name, price, image, quantity: 1 }),
                });
                if (response.ok) {
                    loadCart(); // Reload cart to reflect changes
                    alert(`${name} added to cart!`);
                } else {
                    const errorText = await response.text();
                    console.error('Failed to add to cart:', errorText);
                    alert('Failed to add item to cart');
                }
            } catch (err) {
                console.error('Error adding to cart:', err);
                alert('Error adding item to cart');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadCart();

            proceedBtn.addEventListener('click', function() {
                cartSection.style.display = 'none';
                cartAddSection.style.display = 'none';
                checkoutFormSection.style.display = 'block';
                window.scrollTo({ top: document.querySelector('#page-header').offsetTop, behavior: 'smooth' });
            });

            backToCartBtn.addEventListener('click', function() {
                checkoutFormSection.style.display = 'none';
                cartSection.style.display = 'block';
                cartAddSection.style.display = 'flex';
                window.scrollTo({ top: document.querySelector('#page-header').offsetTop, behavior: 'smooth' });
            });

            placeOrderBtn.addEventListener('click', async function() {
                const shippingForm = document.getElementById('shipping-form');
                const paymentForm = document.getElementById('payment-form');

                if (!shippingForm.checkValidity() || !paymentForm.checkValidity()) {
                    alert('Please fill in all required fields');
                    return;
                }

                const shipping = {
                    fullName: document.getElementById('fullname').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipcode: document.getElementById('zipcode').value,
                    country: document.getElementById('country').value,
                };

                const payment = {
                    cardName: document.getElementById('cardname').value,
                    cardNumber: document.getElementById('cardnumber').value,
                    expiry: document.getElementById('expiry').value,
                    cvv: document.getElementById('cvv').value,
                };

                // Fetch current cart items to include in the order
                let cartItems = [];
                try {
                    const cartResponse = await fetch(`${API_BASE_URL}/api/cart/${userId}`);
                    const cart = await cartResponse.json();
                    if (cart.items && cart.items.length > 0) {
                        cartItems = cart.items.map(item => ({
                            productId: item.productId,
                            name: item.name,
                            price: item.price,
                            image: item.image || 'img/placeholder.jpg', // Fallback if image is missing
                            quantity: item.quantity
                        }));
                        console.log('Cart items before order:', cartItems); // Debug log
                    } else {
                        alert('Your cart is empty. Add items before placing an order.');
                        return;
                    }
                } catch (err) {
                    console.error('Error fetching cart:', err);
                    alert('Error fetching cart');
                    return;
                }

                // Calculate total from cart items
                const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);

                try {
                    const response = await fetch(`${API_BASE_URL}/api/orders/${userId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ shipping, payment, items: cartItems, total }),
                    });
                    if (response.ok) {
                        const order = await response.json();
                        // Clear cart in backend
                        await fetch(`${API_BASE_URL}/api/cart/${userId}`, {
                            method: 'DELETE',
                        });
                        // Show confirmation
                        checkoutFormSection.style.display = 'none';
                        orderConfirmationSection.style.display = 'block';
                        orderNumberEl.textContent = order.orderNumber;
                        confirmationEmailEl.textContent = shipping.email;
                        window.scrollTo({ top: document.querySelector('#page-header').offsetTop, behavior: 'smooth' });
                        // Reset cart UI
                        cartProductsEl.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px;">
                                    <p>Your cart is empty</p>
                                    <button class="normal" onclick="window.location.href='shop.html'" style="margin-top: 20px;">
                                        Continue Shopping
                                    </button>
                                </td>
                            </tr>
                        `;
                        updateCartTotals(0);
                        proceedBtn.disabled = true;
                        proceedBtn.classList.add('disabled');
                    } else {
                        console.error('Failed to place order:', await response.text());
                        alert('Failed to place order');
                    }
                } catch (err) {
                    console.error('Error placing order:', err);
                    alert('Error placing order');
                }
            });
        });
    </script>
</body>

</html>